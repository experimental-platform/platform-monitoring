machine:
  services:
    - docker

dependencies:
  override:
    - ./ci-build.sh
    - docker build -t experimentalplatform/monitoring:$CIRCLE_BRANCH .

test:
  override:
    - "echo 'TODO: Insert some tests here?'"

deployment:
  ignore:
    branch: master
    commands:
      - echo -e "\n\nWe're not uploading master anywhere."
  development:
    branch: development
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push experimentalplatform/monitoring:$CIRCLE_BRANCH
  feature:
    branch: /.*/
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push experimentalplatform/monitoring:$CIRCLE_BRANCH
      - >
        curl
        --header "Content-Type: application/json"
        --data "{\"build_parameters\": {\"SERVICE_TAG\": \"$CIRCLE_BRANCH\", \"SERVICE_NAME\": \"monitoring\"}}"
        --request POST
        https://circleci.com/api/v1/project/experimental-platform/platform-configure/tree/development?circle-token=$CIRCLE_TOKEN